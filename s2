{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# 名寄せマスターの作成\n",
    "- 保有者名、銘柄コード、浮動株フラグのマスターを作成する。\n",
    "- 大株主は浮動の場合もあれば固定の場合もある。自己株式、役員の保有、政策保有株は必ず固定株式"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from pathlib import Path\n",
    "import datetime\n",
    "from dateutil.relativedelta import relativedelta\n",
    "import shutil\n",
    "import mojimoji\n",
    "import math\n",
    "import glob\n",
    "import os\n",
    "import pyodbc\n",
    "settings_pyodbc = {\"DRIVER\":\"{Oracle in OraClient12Home1}\", \n",
    "                    \"SERVER\":\"E03H.WORLD\", \n",
    "                    \"DBQ\":\"E03H\", \n",
    "                    \"UID\":\"DAZ91001\", \n",
    "                    \"PWD\":\"617030\"}\n",
    "#sqlの呼び出し関数\n",
    "def sql(query):\n",
    "    cnxn = pyodbc.connect(**settings_pyodbc)\n",
    "    return pd.read_sql(query, cnxn)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [],
   "source": [
    "pd.set_option('display.max_columns', 100)\n",
    "pd.set_option('display.max_rows', 200)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [],
   "source": [
    "today = int(datetime.date.today().strftime('%Y%m%d'))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 71,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['202406',\n",
       " '202405',\n",
       " '202404',\n",
       " '202403',\n",
       " '202402',\n",
       " '202401',\n",
       " '202312',\n",
       " '202311',\n",
       " '202310',\n",
       " '202309',\n",
       " '202308',\n",
       " '202307',\n",
       " '202306',\n",
       " '202305',\n",
       " '202304',\n",
       " '202303',\n",
       " '202302',\n",
       " '202301',\n",
       " '202212',\n",
       " '202211',\n",
       " '202210',\n",
       " '202209',\n",
       " '202208',\n",
       " '202207']"
      ]
     },
     "execution_count": 71,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#24か月分取る\n",
    "period_end_date = datetime.date(today // 10000, today // 100 % 100, 1)\n",
    "MonthList = []\n",
    "for m in range(24):\n",
    "    month = period_end_date - relativedelta(months=m)\n",
    "    MonthList.append(month.strftime('%Y%m'))\n",
    "MonthList"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>period</th>\n",
       "      <th>fdate</th>\n",
       "      <th>code</th>\n",
       "      <th>name</th>\n",
       "      <th>flg</th>\n",
       "      <th>renban</th>\n",
       "      <th>HolderName</th>\n",
       "      <th>SubHolderName</th>\n",
       "      <th>shares</th>\n",
       "      <th>p1shares</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>日本マスタートラスト信託銀行株式会社（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>12954000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>株式会社日本カストディ銀行（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>6609000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>2</td>\n",
       "      <td>SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>5235000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>3</td>\n",
       "      <td>オーエスジーエージェント会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>3504000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>4</td>\n",
       "      <td>オーエスジー持株会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2621000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3213</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>3</td>\n",
       "      <td>3</td>\n",
       "      <td>中川宏</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3214</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>3</td>\n",
       "      <td>4</td>\n",
       "      <td>三橋信一郎</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3215</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>3</td>\n",
       "      <td>5</td>\n",
       "      <td>市橋卓</td>\n",
       "      <td>NaN</td>\n",
       "      <td>100.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3216</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>3</td>\n",
       "      <td>6</td>\n",
       "      <td>川眞田啓介</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3217</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>5</td>\n",
       "      <td>0</td>\n",
       "      <td>発行済株式数</td>\n",
       "      <td>NaN</td>\n",
       "      <td>10803600.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>3218 rows × 10 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      period     fdate   code        name  flg  renban  \\\n",
       "0     202311  20240216  61360  オーエスジー株式会社    1       0   \n",
       "1     202311  20240216  61360  オーエスジー株式会社    1       1   \n",
       "2     202311  20240216  61360  オーエスジー株式会社    1       2   \n",
       "3     202311  20240216  61360  オーエスジー株式会社    1       3   \n",
       "4     202311  20240216  61360  オーエスジー株式会社    1       4   \n",
       "...      ...       ...    ...         ...  ...     ...   \n",
       "3213  202309  20240131  26670  株式会社イメージワン    3       3   \n",
       "3214  202309  20240131  26670  株式会社イメージワン    3       4   \n",
       "3215  202309  20240131  26670  株式会社イメージワン    3       5   \n",
       "3216  202309  20240131  26670  株式会社イメージワン    3       6   \n",
       "3217  202309  20240131  26670  株式会社イメージワン    5       0   \n",
       "\n",
       "                                             HolderName SubHolderName  \\\n",
       "0                               日本マスタートラスト信託銀行株式会社（信託口）           NaN   \n",
       "1                                    株式会社日本カストディ銀行（信託口）           NaN   \n",
       "2     SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...           NaN   \n",
       "3                                         オーエスジーエージェント会           NaN   \n",
       "4                                             オーエスジー持株会           NaN   \n",
       "...                                                 ...           ...   \n",
       "3213                                                中川宏           NaN   \n",
       "3214                                              三橋信一郎           NaN   \n",
       "3215                                                市橋卓           NaN   \n",
       "3216                                              川眞田啓介           NaN   \n",
       "3217                                             発行済株式数           NaN   \n",
       "\n",
       "          shares  p1shares  \n",
       "0     12954000.0       NaN  \n",
       "1      6609000.0       NaN  \n",
       "2      5235000.0       NaN  \n",
       "3      3504000.0       NaN  \n",
       "4      2621000.0       NaN  \n",
       "...          ...       ...  \n",
       "3213         0.0       NaN  \n",
       "3214         0.0       NaN  \n",
       "3215       100.0       NaN  \n",
       "3216         0.0       NaN  \n",
       "3217  10803600.0       NaN  \n",
       "\n",
       "[3218 rows x 10 columns]"
      ]
     },
     "execution_count": 26,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_input = pd.DataFrame()\n",
    "for m in MonthList:\n",
    "    path_yuho = r\"R:\\Users\\2141298\\PM\\Analysis\\tpx\\yuho\\{}.xlsx\".format(m)\n",
    "    if os.path.isfile(path_yuho):\n",
    "        df_input_ = pd.read_excel(path_yuho, dtype={'period':'int32', 'fdate':'int32', 'code':str, 'flg':'int8', 'renban':'int32'})\n",
    "        df_input = pd.concat([df_input, df_input_])\n",
    "df_input = df_input.reset_index(drop=True)\n",
    "df_input"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "metadata": {},
   "outputs": [],
   "source": [
    "#データ区分ごとに分ける\n",
    "df_ookabunusi = df_input[df_input['flg']==1].copy()\n",
    "df_jikokabu = df_input[df_input['flg']==2].copy()\n",
    "df_yakuin = df_input[df_input['flg']==3].copy()\n",
    "df_seisaku = df_input[df_input['flg']==4].copy()\n",
    "df_hakkouzumi = df_input[df_input['flg']==5].copy()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 72,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>period</th>\n",
       "      <th>fdate</th>\n",
       "      <th>code</th>\n",
       "      <th>name</th>\n",
       "      <th>flg</th>\n",
       "      <th>renban</th>\n",
       "      <th>HolderName</th>\n",
       "      <th>SubHolderName</th>\n",
       "      <th>shares</th>\n",
       "      <th>p1shares</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [period, fdate, code, name, flg, renban, HolderName, SubHolderName, shares, p1shares]\n",
       "Index: []"
      ]
     },
     "execution_count": 72,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_input[df_input['name'].isnull()]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# データチェック"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "122\n"
     ]
    }
   ],
   "source": [
    "print(len(df_input['code'].unique()))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>period</th>\n",
       "      <th>fdate</th>\n",
       "      <th>code</th>\n",
       "      <th>name</th>\n",
       "      <th>flg</th>\n",
       "      <th>renban</th>\n",
       "      <th>HolderName</th>\n",
       "      <th>SubHolderName</th>\n",
       "      <th>shares</th>\n",
       "      <th>p1shares</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [period, fdate, code, name, flg, renban, HolderName, SubHolderName, shares, p1shares]\n",
       "Index: []"
      ]
     },
     "execution_count": 31,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#上場廃止している銘柄はCODEがない、てかバグかな\n",
    "df_input[df_input['code'].isnull()]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 有報自体は存在しているのに特定のデータが読み込めていない場合をチェック"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "metadata": {},
   "outputs": [],
   "source": [
    "set_input = set(df_input['code'].unique())\n",
    "set_ookabunusi = set(df_ookabunusi['code'].unique())\n",
    "set_jikokabu = set(df_jikokabu['code'].unique())\n",
    "set_yakuin = set(df_yakuin['code'].unique())\n",
    "set_seisaku = set(df_seisaku['code'].unique())\n",
    "set_hakkouzumi = set(df_hakkouzumi['code'].unique())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "set()"
      ]
     },
     "execution_count": 33,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "set_input  - set_ookabunusi"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "set()"
      ]
     },
     "execution_count": 34,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "set_input - set_jikokabu"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "set()"
      ]
     },
     "execution_count": 35,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "set_input - set_yakuin"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "set()"
      ]
     },
     "execution_count": 36,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "set_input - set_hakkouzumi"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 39,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>period</th>\n",
       "      <th>fdate</th>\n",
       "      <th>code</th>\n",
       "      <th>name</th>\n",
       "      <th>flg</th>\n",
       "      <th>renban</th>\n",
       "      <th>HolderName</th>\n",
       "      <th>SubHolderName</th>\n",
       "      <th>shares</th>\n",
       "      <th>p1shares</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>日本マスタートラスト信託銀行株式会社（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>12954000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>株式会社日本カストディ銀行（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>6609000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>2</td>\n",
       "      <td>SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>5235000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>3</td>\n",
       "      <td>オーエスジーエージェント会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>3504000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>4</td>\n",
       "      <td>オーエスジー持株会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2621000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2692</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>NaN</td>\n",
       "      <td>74500.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2693</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>3</td>\n",
       "      <td>1</td>\n",
       "      <td>川倉歩</td>\n",
       "      <td>NaN</td>\n",
       "      <td>5364.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2694</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>3</td>\n",
       "      <td>2</td>\n",
       "      <td>武井保人</td>\n",
       "      <td>NaN</td>\n",
       "      <td>149.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2695</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>3</td>\n",
       "      <td>5</td>\n",
       "      <td>市橋卓</td>\n",
       "      <td>NaN</td>\n",
       "      <td>100.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2696</th>\n",
       "      <td>202309</td>\n",
       "      <td>20240131</td>\n",
       "      <td>26670</td>\n",
       "      <td>株式会社イメージワン</td>\n",
       "      <td>5</td>\n",
       "      <td>0</td>\n",
       "      <td>発行済株式数</td>\n",
       "      <td>NaN</td>\n",
       "      <td>10803600.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>2697 rows × 10 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      period     fdate   code        name  flg  renban  \\\n",
       "0     202311  20240216  61360  オーエスジー株式会社    1       0   \n",
       "1     202311  20240216  61360  オーエスジー株式会社    1       1   \n",
       "2     202311  20240216  61360  オーエスジー株式会社    1       2   \n",
       "3     202311  20240216  61360  オーエスジー株式会社    1       3   \n",
       "4     202311  20240216  61360  オーエスジー株式会社    1       4   \n",
       "...      ...       ...    ...         ...  ...     ...   \n",
       "2692  202309  20240131  26670  株式会社イメージワン    2       0   \n",
       "2693  202309  20240131  26670  株式会社イメージワン    3       1   \n",
       "2694  202309  20240131  26670  株式会社イメージワン    3       2   \n",
       "2695  202309  20240131  26670  株式会社イメージワン    3       5   \n",
       "2696  202309  20240131  26670  株式会社イメージワン    5       0   \n",
       "\n",
       "                                             HolderName SubHolderName  \\\n",
       "0                               日本マスタートラスト信託銀行株式会社（信託口）           NaN   \n",
       "1                                    株式会社日本カストディ銀行（信託口）           NaN   \n",
       "2     SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...           NaN   \n",
       "3                                         オーエスジーエージェント会           NaN   \n",
       "4                                             オーエスジー持株会           NaN   \n",
       "...                                                 ...           ...   \n",
       "2692                                         株式会社イメージワン           NaN   \n",
       "2693                                                川倉歩           NaN   \n",
       "2694                                               武井保人           NaN   \n",
       "2695                                                市橋卓           NaN   \n",
       "2696                                             発行済株式数           NaN   \n",
       "\n",
       "          shares  p1shares  \n",
       "0     12954000.0       NaN  \n",
       "1      6609000.0       NaN  \n",
       "2      5235000.0       NaN  \n",
       "3      3504000.0       NaN  \n",
       "4      2621000.0       NaN  \n",
       "...          ...       ...  \n",
       "2692     74500.0       NaN  \n",
       "2693      5364.0       NaN  \n",
       "2694       149.0       NaN  \n",
       "2695       100.0       NaN  \n",
       "2696  10803600.0       NaN  \n",
       "\n",
       "[2697 rows x 10 columns]"
      ]
     },
     "execution_count": 39,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#役員と政策保有株は保有株が０でも行が存在するので削除する\n",
    "df_input = df_input[~((df_input['shares'] == 0) & (df_input['flg'].isin([3,4])))].reset_index(drop=True)\n",
    "df_input"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# 政策保有株式以外はTOPIX銘柄のみにする"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 40,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\2141298\\AppData\\Local\\Temp\\ipykernel_18732\\3657014005.py:10: UserWarning: pandas only supports SQLAlchemy connectable (engine/connection) or database string URI or sqlite3 DBAPI2 connection. Other DBAPI2 objects are not tested. Please consider using SQLAlchemy.\n",
      "  return pd.read_sql(query, cnxn)\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "['13010',\n",
       " '13320',\n",
       " '13330',\n",
       " '13750',\n",
       " '13760',\n",
       " '13770',\n",
       " '13790',\n",
       " '13840',\n",
       " '14140',\n",
       " '14170',\n",
       " '14190',\n",
       " '14200',\n",
       " '14290',\n",
       " '14300',\n",
       " '14330',\n",
       " '14350',\n",
       " '14460',\n",
       " '15140',\n",
       " '15150',\n",
       " '15180',\n",
       " '16050',\n",
       " '16620',\n",
       " '16630',\n",
       " '167A0',\n",
       " '17120',\n",
       " '17160',\n",
       " '17170',\n",
       " '17190',\n",
       " '17200',\n",
       " '17210',\n",
       " '17260',\n",
       " '17620',\n",
       " '17660',\n",
       " '17680',\n",
       " '17800',\n",
       " '17860',\n",
       " '18010',\n",
       " '18020',\n",
       " '18030',\n",
       " '18050',\n",
       " '18080',\n",
       " '18100',\n",
       " '18110',\n",
       " '18120',\n",
       " '18130',\n",
       " '18140',\n",
       " '18150',\n",
       " '18200',\n",
       " '18210',\n",
       " '18220',\n",
       " '18260',\n",
       " '18270',\n",
       " '18330',\n",
       " '18350',\n",
       " '18470',\n",
       " '18480',\n",
       " '18520',\n",
       " '18600',\n",
       " '18610',\n",
       " '18660',\n",
       " '18670',\n",
       " '18700',\n",
       " '18710',\n",
       " '18730',\n",
       " '18780',\n",
       " '18790',\n",
       " '187A0',\n",
       " '18820',\n",
       " '18840',\n",
       " '18850',\n",
       " '18870',\n",
       " '18880',\n",
       " '18900',\n",
       " '18930',\n",
       " '18980',\n",
       " '18990',\n",
       " '19090',\n",
       " '19110',\n",
       " '19140',\n",
       " '19210',\n",
       " '19250',\n",
       " '19260',\n",
       " '19280',\n",
       " '19290',\n",
       " '19300',\n",
       " '19340',\n",
       " '19380',\n",
       " '19390',\n",
       " '19410',\n",
       " '19420',\n",
       " '19440',\n",
       " '19450',\n",
       " '19460',\n",
       " '19490',\n",
       " '19500',\n",
       " '19510',\n",
       " '19520',\n",
       " '19590',\n",
       " '19610',\n",
       " '19630',\n",
       " '19640',\n",
       " '19670',\n",
       " '19680',\n",
       " '19690',\n",
       " '19720',\n",
       " '19730',\n",
       " '19750',\n",
       " '19760',\n",
       " '19790',\n",
       " '19800',\n",
       " '19820',\n",
       " '20010',\n",
       " '20020',\n",
       " '20030',\n",
       " '20040',\n",
       " '20090',\n",
       " '20530',\n",
       " '20600',\n",
       " '21070',\n",
       " '21080',\n",
       " '21090',\n",
       " '21120',\n",
       " '21170',\n",
       " '21200',\n",
       " '21210',\n",
       " '21240',\n",
       " '21270',\n",
       " '21300',\n",
       " '21390',\n",
       " '21460',\n",
       " '21480',\n",
       " '21500',\n",
       " '21530',\n",
       " '21540',\n",
       " '21570',\n",
       " '21630',\n",
       " '21680',\n",
       " '21690',\n",
       " '21700',\n",
       " '21750',\n",
       " '21800',\n",
       " '21810',\n",
       " '21830',\n",
       " '21930',\n",
       " '21960',\n",
       " '21980',\n",
       " '22010',\n",
       " '22040',\n",
       " '22060',\n",
       " '22070',\n",
       " '22090',\n",
       " '22110',\n",
       " '22120',\n",
       " '22150',\n",
       " '22170',\n",
       " '22200',\n",
       " '22220',\n",
       " '22290',\n",
       " '22640',\n",
       " '22660',\n",
       " '22670',\n",
       " '22690',\n",
       " '22700',\n",
       " '22810',\n",
       " '22820',\n",
       " '22860',\n",
       " '22880',\n",
       " '22920',\n",
       " '22940',\n",
       " '22960',\n",
       " '23010',\n",
       " '23050',\n",
       " '23070',\n",
       " '23110',\n",
       " '23170',\n",
       " '23250',\n",
       " '23260',\n",
       " '23270',\n",
       " '23310',\n",
       " '23350',\n",
       " '23370',\n",
       " '23530',\n",
       " '23590',\n",
       " '23710',\n",
       " '23720',\n",
       " '23740',\n",
       " '23760',\n",
       " '23780',\n",
       " '23790',\n",
       " '23840',\n",
       " '23890',\n",
       " '23950',\n",
       " '24100',\n",
       " '24130',\n",
       " '24180',\n",
       " '24240',\n",
       " '24280',\n",
       " '24290',\n",
       " '24320',\n",
       " '24330',\n",
       " '24400',\n",
       " '24450',\n",
       " '24610',\n",
       " '24620',\n",
       " '24640',\n",
       " '24710',\n",
       " '24750',\n",
       " '24770',\n",
       " '24850',\n",
       " '24870',\n",
       " '24890',\n",
       " '24910',\n",
       " '24920',\n",
       " '25010',\n",
       " '25020',\n",
       " '25030',\n",
       " '25310',\n",
       " '25330',\n",
       " '25400',\n",
       " '25790',\n",
       " '25850',\n",
       " '25870',\n",
       " '25900',\n",
       " '25930',\n",
       " '25940',\n",
       " '25970',\n",
       " '25990',\n",
       " '26020',\n",
       " '26070',\n",
       " '26120',\n",
       " '26130',\n",
       " '26510',\n",
       " '26590',\n",
       " '26640',\n",
       " '26700',\n",
       " '26740',\n",
       " '26760',\n",
       " '26780',\n",
       " '26810',\n",
       " '26850',\n",
       " '26860',\n",
       " '26870',\n",
       " '26890',\n",
       " '26920',\n",
       " '26950',\n",
       " '26980',\n",
       " '27150',\n",
       " '27220',\n",
       " '27260',\n",
       " '27300',\n",
       " '27330',\n",
       " '27340',\n",
       " '27350',\n",
       " '27370',\n",
       " '27420',\n",
       " '27490',\n",
       " '27520',\n",
       " '27530',\n",
       " '27600',\n",
       " '27640',\n",
       " '27670',\n",
       " '27680',\n",
       " '27840',\n",
       " '27910',\n",
       " '27920',\n",
       " '27960',\n",
       " '28010',\n",
       " '28020',\n",
       " '28040',\n",
       " '28090',\n",
       " '28100',\n",
       " '28110',\n",
       " '28150',\n",
       " '28180',\n",
       " '28190',\n",
       " '28200',\n",
       " '28710',\n",
       " '28740',\n",
       " '28750',\n",
       " '28820',\n",
       " '28830',\n",
       " '28840',\n",
       " '28970',\n",
       " '28990',\n",
       " '29040',\n",
       " '29080',\n",
       " '29100',\n",
       " '29140',\n",
       " '29150',\n",
       " '29180',\n",
       " '29220',\n",
       " '29240',\n",
       " '29290',\n",
       " '29300',\n",
       " '29310',\n",
       " '29330',\n",
       " '29350',\n",
       " '29750',\n",
       " '29800',\n",
       " '29820',\n",
       " '30010',\n",
       " '30020',\n",
       " '30030',\n",
       " '30040',\n",
       " '30230',\n",
       " '30280',\n",
       " '30300',\n",
       " '30310',\n",
       " '30340',\n",
       " '30360',\n",
       " '30380',\n",
       " '30400',\n",
       " '30460',\n",
       " '30480',\n",
       " '30500',\n",
       " '30530',\n",
       " '30540',\n",
       " '30640',\n",
       " '30670',\n",
       " '30730',\n",
       " '30760',\n",
       " '30790',\n",
       " '30820',\n",
       " '30860',\n",
       " '30870',\n",
       " '30880',\n",
       " '30910',\n",
       " '30920',\n",
       " '30930',\n",
       " '30970',\n",
       " '30990',\n",
       " '31010',\n",
       " '31030',\n",
       " '31040',\n",
       " '31050',\n",
       " '31060',\n",
       " '31070',\n",
       " '31090',\n",
       " '31100',\n",
       " '31160',\n",
       " '31320',\n",
       " '31340',\n",
       " '31350',\n",
       " '31390',\n",
       " '31410',\n",
       " '31480',\n",
       " '31500',\n",
       " '31510',\n",
       " '31530',\n",
       " '31540',\n",
       " '31560',\n",
       " '31570',\n",
       " '31590',\n",
       " '31600',\n",
       " '31660',\n",
       " '31670',\n",
       " '31680',\n",
       " '31690',\n",
       " '31720',\n",
       " '31730',\n",
       " '31750',\n",
       " '31760',\n",
       " '31780',\n",
       " '31790',\n",
       " '31800',\n",
       " '31820',\n",
       " '31830',\n",
       " '31860',\n",
       " '31910',\n",
       " '31930',\n",
       " '31960',\n",
       " '31970',\n",
       " '31980',\n",
       " '31990',\n",
       " '32010',\n",
       " '32020',\n",
       " '32040',\n",
       " '32050',\n",
       " '32210',\n",
       " '32220',\n",
       " '32310',\n",
       " '32320',\n",
       " '32450',\n",
       " '32460',\n",
       " '32520',\n",
       " '32540',\n",
       " '32670',\n",
       " '32710',\n",
       " '32750',\n",
       " '32760',\n",
       " '32770',\n",
       " '32800',\n",
       " '32840',\n",
       " '32880',\n",
       " '32890',\n",
       " '32910',\n",
       " '32940',\n",
       " '32990',\n",
       " '33020',\n",
       " '33150',\n",
       " '33190',\n",
       " '33210',\n",
       " '33280',\n",
       " '33330',\n",
       " '33410',\n",
       " '33490',\n",
       " '33600',\n",
       " '33610',\n",
       " '33710',\n",
       " '33820',\n",
       " '33870',\n",
       " '33880',\n",
       " '33910',\n",
       " '33920',\n",
       " '33930',\n",
       " '33950',\n",
       " '33960',\n",
       " '33970',\n",
       " '34010',\n",
       " '34020',\n",
       " '34050',\n",
       " '34070',\n",
       " '34150',\n",
       " '34210',\n",
       " '34310',\n",
       " '34330',\n",
       " '34340',\n",
       " '34360',\n",
       " '34430',\n",
       " '34450',\n",
       " '34460',\n",
       " '34470',\n",
       " '34520',\n",
       " '34540',\n",
       " '34570',\n",
       " '34580',\n",
       " '34650',\n",
       " '34670',\n",
       " '34750',\n",
       " '34800',\n",
       " '34820',\n",
       " '34840',\n",
       " '34860',\n",
       " '34890',\n",
       " '34980',\n",
       " '35010',\n",
       " '35120',\n",
       " '35130',\n",
       " '35210',\n",
       " '35240',\n",
       " '35260',\n",
       " '35290',\n",
       " '35380',\n",
       " '35390',\n",
       " '35430',\n",
       " '35440',\n",
       " '35460',\n",
       " '35470',\n",
       " '35480',\n",
       " '35490',\n",
       " '35510',\n",
       " '35530',\n",
       " '35590',\n",
       " '35610',\n",
       " '35630',\n",
       " '35650',\n",
       " '35690',\n",
       " '35710',\n",
       " '35770',\n",
       " '35800',\n",
       " '35910',\n",
       " '35930',\n",
       " '36070',\n",
       " '36080',\n",
       " '36110',\n",
       " '36120',\n",
       " '36260',\n",
       " '36270',\n",
       " '36320',\n",
       " '36330',\n",
       " '36350',\n",
       " '36360',\n",
       " '36390',\n",
       " '36400',\n",
       " '36480',\n",
       " '36490',\n",
       " '36550',\n",
       " '36560',\n",
       " '36570',\n",
       " '36590',\n",
       " '36600',\n",
       " '36610',\n",
       " '36620',\n",
       " '36650',\n",
       " '36660',\n",
       " '36670',\n",
       " '36680',\n",
       " '36720',\n",
       " '36730',\n",
       " '36750',\n",
       " '36760',\n",
       " '36780',\n",
       " '36790',\n",
       " '36810',\n",
       " '36820',\n",
       " '36830',\n",
       " '36860',\n",
       " '36870',\n",
       " '36880',\n",
       " '36940',\n",
       " '36960',\n",
       " '36970',\n",
       " '37080',\n",
       " '37380',\n",
       " '37410',\n",
       " '37620',\n",
       " '37630',\n",
       " '37650',\n",
       " '37690',\n",
       " '37700',\n",
       " '37710',\n",
       " '37740',\n",
       " '37780',\n",
       " '37880',\n",
       " '38170',\n",
       " '38260',\n",
       " '38340',\n",
       " '38350',\n",
       " '38360',\n",
       " '38370',\n",
       " '38390',\n",
       " '38430',\n",
       " '38440',\n",
       " '38530',\n",
       " '38540',\n",
       " '38610',\n",
       " '38630',\n",
       " '38640',\n",
       " '38650',\n",
       " '38770',\n",
       " '38780',\n",
       " '38800',\n",
       " '38960',\n",
       " '39010',\n",
       " '39020',\n",
       " '39030',\n",
       " '39090',\n",
       " '39120',\n",
       " '39150',\n",
       " '39160',\n",
       " '39180',\n",
       " '39200',\n",
       " '39210',\n",
       " '39220',\n",
       " '39230',\n",
       " '39240',\n",
       " '39250',\n",
       " '39260',\n",
       " '39280',\n",
       " '39320',\n",
       " '39340',\n",
       " '39370',\n",
       " '39390',\n",
       " '39400',\n",
       " '39410',\n",
       " '39460',\n",
       " '39500',\n",
       " '39620',\n",
       " '39630',\n",
       " '39640',\n",
       " '39650',\n",
       " '39680',\n",
       " '39690',\n",
       " '39780',\n",
       " '39810',\n",
       " '39830',\n",
       " '39840',\n",
       " '39850',\n",
       " '39920',\n",
       " '39940',\n",
       " '39960',\n",
       " '40040',\n",
       " '40050',\n",
       " '40080',\n",
       " '40210',\n",
       " '40220',\n",
       " '40230',\n",
       " '40250',\n",
       " '40270',\n",
       " '40280',\n",
       " '40310',\n",
       " '40410',\n",
       " '40420',\n",
       " '40430',\n",
       " '40440',\n",
       " '40450',\n",
       " '40460',\n",
       " '40470',\n",
       " '40530',\n",
       " '40610',\n",
       " '40620',\n",
       " '40630',\n",
       " '40640',\n",
       " '40710',\n",
       " '40720',\n",
       " '40780',\n",
       " '40820',\n",
       " '40880',\n",
       " '40910',\n",
       " '40920',\n",
       " '40930',\n",
       " '40950',\n",
       " '40970',\n",
       " '40980',\n",
       " '40990',\n",
       " '41000',\n",
       " '41090',\n",
       " '41120',\n",
       " '41140',\n",
       " '41160',\n",
       " '41180',\n",
       " '41510',\n",
       " '41800',\n",
       " '41820',\n",
       " '41830',\n",
       " '41860',\n",
       " '41870',\n",
       " '41880',\n",
       " '41890',\n",
       " '41940',\n",
       " '42020',\n",
       " '42030',\n",
       " '42040',\n",
       " '42050',\n",
       " '42060',\n",
       " '42080',\n",
       " '42120',\n",
       " '42150',\n",
       " '42160',\n",
       " '42180',\n",
       " '42200',\n",
       " '42210',\n",
       " '42280',\n",
       " '42290',\n",
       " '42310',\n",
       " '42380',\n",
       " '42450',\n",
       " '42460',\n",
       " '42480',\n",
       " '42490',\n",
       " '42510',\n",
       " '42720',\n",
       " '42750',\n",
       " '42840',\n",
       " '42860',\n",
       " '42900',\n",
       " '42950',\n",
       " '42980',\n",
       " '42990',\n",
       " '43010',\n",
       " '43070',\n",
       " '43100',\n",
       " '43180',\n",
       " '43190',\n",
       " '43200',\n",
       " '43230',\n",
       " '43240',\n",
       " '43260',\n",
       " '43310',\n",
       " '43330',\n",
       " '43370',\n",
       " '43430',\n",
       " '43440',\n",
       " '43450',\n",
       " '43460',\n",
       " '43480',\n",
       " '43500',\n",
       " '43620',\n",
       " '43680',\n",
       " '43690',\n",
       " '43730',\n",
       " '43820',\n",
       " '43840',\n",
       " '43850',\n",
       " '43900',\n",
       " '43920',\n",
       " '43960',\n",
       " '44010',\n",
       " '44030',\n",
       " '44040',\n",
       " '44060',\n",
       " '44100',\n",
       " '44200',\n",
       " '44300',\n",
       " '44320',\n",
       " '44330',\n",
       " '44340',\n",
       " '44390',\n",
       " '44400',\n",
       " '44410',\n",
       " '44430',\n",
       " '44460',\n",
       " '44490',\n",
       " '44520',\n",
       " '44610',\n",
       " '44620',\n",
       " '44630',\n",
       " '44650',\n",
       " '44710',\n",
       " '44800',\n",
       " '44810',\n",
       " '44830',\n",
       " '45020',\n",
       " '45030',\n",
       " '45060',\n",
       " '45070',\n",
       " '45120',\n",
       " '45160',\n",
       " '45190',\n",
       " '45210',\n",
       " '45230',\n",
       " '45260',\n",
       " '45270',\n",
       " '45280',\n",
       " '45300',\n",
       " '45310',\n",
       " '45340',\n",
       " '45360',\n",
       " '45380',\n",
       " '45390',\n",
       " '45400',\n",
       " '45430',\n",
       " '45440',\n",
       " '45470',\n",
       " '45480',\n",
       " '45490',\n",
       " '45510',\n",
       " '45520',\n",
       " '45530',\n",
       " '45540',\n",
       " '45590',\n",
       " '45650',\n",
       " '45680',\n",
       " '45690',\n",
       " '45740',\n",
       " '45770',\n",
       " '45780',\n",
       " '45870',\n",
       " '46110',\n",
       " '46120',\n",
       " '46130',\n",
       " '46150',\n",
       " '46170',\n",
       " '46190',\n",
       " '46200',\n",
       " '46260',\n",
       " '46310',\n",
       " '46330',\n",
       " '46340',\n",
       " '46410',\n",
       " '46510',\n",
       " '46580',\n",
       " '46610',\n",
       " '46620',\n",
       " '46650',\n",
       " '46660',\n",
       " '46680',\n",
       " '46710',\n",
       " '46740',\n",
       " '46760',\n",
       " '46780',\n",
       " '46790',\n",
       " '46800',\n",
       " '46810',\n",
       " '46840',\n",
       " '46860',\n",
       " '46870',\n",
       " '46890',\n",
       " '46940',\n",
       " '47040',\n",
       " '47090',\n",
       " '47140',\n",
       " '47160',\n",
       " '47180',\n",
       " '47190',\n",
       " '47220',\n",
       " '47250',\n",
       " '47260',\n",
       " '47280',\n",
       " '47320',\n",
       " '47330',\n",
       " '47430',\n",
       " '47450',\n",
       " '47460',\n",
       " '47510',\n",
       " '47550',\n",
       " '47620',\n",
       " '47630',\n",
       " '47650',\n",
       " '47670',\n",
       " '47680',\n",
       " '47760',\n",
       " '47920',\n",
       " '48010',\n",
       " '48090',\n",
       " '48120',\n",
       " '48130',\n",
       " '48190',\n",
       " '48200',\n",
       " '48250',\n",
       " '48260',\n",
       " '48280',\n",
       " '48290',\n",
       " '48390',\n",
       " '48450',\n",
       " '48470',\n",
       " '48480',\n",
       " '48490',\n",
       " '48800',\n",
       " '48860',\n",
       " '48870',\n",
       " '49010',\n",
       " '49020',\n",
       " '49110',\n",
       " '49120',\n",
       " '49140',\n",
       " '49170',\n",
       " '49190',\n",
       " '49210',\n",
       " '49220',\n",
       " '49230',\n",
       " '49260',\n",
       " '49270',\n",
       " '49280',\n",
       " '49290',\n",
       " '49310',\n",
       " '49330',\n",
       " '49360',\n",
       " '49510',\n",
       " '49550',\n",
       " '49560',\n",
       " '49580',\n",
       " '49670',\n",
       " '49680',\n",
       " '49710',\n",
       " '49730',\n",
       " '49740',\n",
       " '49750',\n",
       " '49770',\n",
       " '49790',\n",
       " '49800',\n",
       " '49850',\n",
       " '49920',\n",
       " '49940',\n",
       " '49960',\n",
       " '49970',\n",
       " '50090',\n",
       " '50110',\n",
       " '50130',\n",
       " '50150',\n",
       " '50170',\n",
       " '50180',\n",
       " '50190',\n",
       " '50200',\n",
       " '50210',\n",
       " '50320',\n",
       " '50740',\n",
       " '50760',\n",
       " '51010',\n",
       " '51050',\n",
       " '51080',\n",
       " '51100',\n",
       " '51210',\n",
       " '51220',\n",
       " '51420',\n",
       " '51850',\n",
       " '51860',\n",
       " '51870',\n",
       " '51910',\n",
       " '51920',\n",
       " '51950',\n",
       " '52010',\n",
       " '52020',\n",
       " '52040',\n",
       " '52080',\n",
       " '52100',\n",
       " '52140',\n",
       " '52180',\n",
       " '52320',\n",
       " '52330',\n",
       " '52610',\n",
       " '52620',\n",
       " '52690',\n",
       " '52730',\n",
       " '52880',\n",
       " '53010',\n",
       " '53020',\n",
       " '53100',\n",
       " '53310',\n",
       " '53320',\n",
       " '53330',\n",
       " '53340',\n",
       " '53370',\n",
       " '53440',\n",
       " '53510',\n",
       " '53520',\n",
       " '53570',\n",
       " '53630',\n",
       " '53670',\n",
       " '53840',\n",
       " '53880',\n",
       " '53910',\n",
       " '53930',\n",
       " '54010',\n",
       " '54060',\n",
       " '54080',\n",
       " '54100',\n",
       " '54110',\n",
       " '54230',\n",
       " '54400',\n",
       " '54440',\n",
       " '54450',\n",
       " '54490',\n",
       " '54510',\n",
       " '54610',\n",
       " '54630',\n",
       " '54640',\n",
       " '54710',\n",
       " '54760',\n",
       " '54800',\n",
       " '54810',\n",
       " '54820',\n",
       " '54910',\n",
       " '55350',\n",
       " '55410',\n",
       " '55630',\n",
       " '56020',\n",
       " '56030',\n",
       " '56120',\n",
       " '56310',\n",
       " '56320',\n",
       " '56580',\n",
       " '56590',\n",
       " '56980',\n",
       " '57020',\n",
       " '57030',\n",
       " '57060',\n",
       " '57070',\n",
       " '57110',\n",
       " '57130',\n",
       " '57140',\n",
       " '57150',\n",
       " '57210',\n",
       " '57260',\n",
       " '57270',\n",
       " '57410',\n",
       " '57570',\n",
       " '58010',\n",
       " '58020',\n",
       " '58030',\n",
       " '58050',\n",
       " '58090',\n",
       " '58190',\n",
       " '58210',\n",
       " '58300',\n",
       " '58310',\n",
       " '58320',\n",
       " '58380',\n",
       " '58440',\n",
       " '58510',\n",
       " '58520',\n",
       " '58570',\n",
       " '59010',\n",
       " '59020',\n",
       " '59090',\n",
       " '59110',\n",
       " '59150',\n",
       " '59230',\n",
       " '59290',\n",
       " '59300',\n",
       " '59320',\n",
       " '59330',\n",
       " '59360',\n",
       " '59380',\n",
       " '59420',\n",
       " '59430',\n",
       " '59460',\n",
       " '59470',\n",
       " '59490',\n",
       " '59510',\n",
       " '59570',\n",
       " '59580',\n",
       " '59590',\n",
       " '59700',\n",
       " '59750',\n",
       " '59760',\n",
       " '59810',\n",
       " '59850',\n",
       " '59860',\n",
       " '59880',\n",
       " ...]"
      ]
     },
     "execution_count": 40,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#TOPIX採用銘柄以外の銘柄に関しては大株主、自己株式、役員は関係ないので抜く。政策保有株は全上場銘柄が必要。\n",
    "def sql_topix_code():\n",
    "    query = f'''\n",
    "SELECT\n",
    "    CODE\n",
    "FROM\n",
    "    PT2.V_MD_EQ_BASE_TOPIX_S\n",
    "WHERE\n",
    "    D_DATE = '{today}' and\n",
    "    SIZE2 <= 7\n",
    "ORDER BY\n",
    "    CODE\n",
    "    '''\n",
    "    return sql(query)\n",
    "list_topix_code = sql_topix_code()['CODE'].values.tolist()\n",
    "list_topix_code"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 51,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>period</th>\n",
       "      <th>fdate</th>\n",
       "      <th>code</th>\n",
       "      <th>name</th>\n",
       "      <th>flg</th>\n",
       "      <th>renban</th>\n",
       "      <th>HolderName</th>\n",
       "      <th>SubHolderName</th>\n",
       "      <th>shares</th>\n",
       "      <th>p1shares</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>日本マスタートラスト信託銀行株式会社（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>12954000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>株式会社日本カストディ銀行（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>6609000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>2</td>\n",
       "      <td>SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>5235000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>3</td>\n",
       "      <td>オーエスジーエージェント会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>3504000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>4</td>\n",
       "      <td>オーエスジー持株会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2621000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1410</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>2</td>\n",
       "      <td>藤井誠二</td>\n",
       "      <td>NaN</td>\n",
       "      <td>100000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1411</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>3</td>\n",
       "      <td>末廣紀彦</td>\n",
       "      <td>NaN</td>\n",
       "      <td>184000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1412</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>4</td>\n",
       "      <td>榎正規</td>\n",
       "      <td>NaN</td>\n",
       "      <td>63000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1413</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>5</td>\n",
       "      <td>寺田三男</td>\n",
       "      <td>NaN</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1414</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>6</td>\n",
       "      <td>原俊之</td>\n",
       "      <td>NaN</td>\n",
       "      <td>80000.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1415 rows × 10 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      period     fdate   code             name  flg  renban  \\\n",
       "0     202311  20240216  61360       オーエスジー株式会社    1       0   \n",
       "1     202311  20240216  61360       オーエスジー株式会社    1       1   \n",
       "2     202311  20240216  61360       オーエスジー株式会社    1       2   \n",
       "3     202311  20240216  61360       オーエスジー株式会社    1       3   \n",
       "4     202311  20240216  61360       オーエスジー株式会社    1       4   \n",
       "...      ...       ...    ...              ...  ...     ...   \n",
       "1410  202310  20240131  92790  株式会社ギフトホールディングス    3       2   \n",
       "1411  202310  20240131  92790  株式会社ギフトホールディングス    3       3   \n",
       "1412  202310  20240131  92790  株式会社ギフトホールディングス    3       4   \n",
       "1413  202310  20240131  92790  株式会社ギフトホールディングス    3       5   \n",
       "1414  202310  20240131  92790  株式会社ギフトホールディングス    3       6   \n",
       "\n",
       "                                             HolderName SubHolderName  \\\n",
       "0                               日本マスタートラスト信託銀行株式会社（信託口）           NaN   \n",
       "1                                    株式会社日本カストディ銀行（信託口）           NaN   \n",
       "2     SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...           NaN   \n",
       "3                                         オーエスジーエージェント会           NaN   \n",
       "4                                             オーエスジー持株会           NaN   \n",
       "...                                                 ...           ...   \n",
       "1410                                               藤井誠二           NaN   \n",
       "1411                                               末廣紀彦           NaN   \n",
       "1412                                                榎正規           NaN   \n",
       "1413                                               寺田三男           NaN   \n",
       "1414                                                原俊之           NaN   \n",
       "\n",
       "          shares  p1shares  \n",
       "0     12954000.0       NaN  \n",
       "1      6609000.0       NaN  \n",
       "2      5235000.0       NaN  \n",
       "3      3504000.0       NaN  \n",
       "4      2621000.0       NaN  \n",
       "...          ...       ...  \n",
       "1410    100000.0       NaN  \n",
       "1411    184000.0       NaN  \n",
       "1412     63000.0       NaN  \n",
       "1413      4000.0       NaN  \n",
       "1414     80000.0       NaN  \n",
       "\n",
       "[1415 rows x 10 columns]"
      ]
     },
     "execution_count": 51,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_input1 = df_input[(df_input['flg'].isin([1,2,3]) & df_input['code'].isin(list_topix_code)) | (df_input['flg'] == 4)].reset_index(drop=True)\n",
    "df_input1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "86"
      ]
     },
     "execution_count": 52,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "len(df_input1['code'].unique())"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# マスターを作成するために名寄せをする"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 59,
   "metadata": {},
   "outputs": [],
   "source": [
    "#マスターと結合するための名寄せ\n",
    "def func_nayose(df, colum):\n",
    "    df[colum + '_Nayose'] = df[colum]\n",
    "    \n",
    "    colum = colum + '_Nayose'\n",
    "    #半角を全角にする\n",
    "    df[colum] = df[colum].apply(mojimoji.han_to_zen)\n",
    "    df[colum] = df[colum].str.replace('㈱', '')\n",
    "    df[colum] = df[colum].str.replace('（株）', '')\n",
    "    df[colum] = df[colum].str.replace('株式会社', '')\n",
    "    df[colum] = df[colum].str.replace('㈲', '有限会社')\n",
    "    df[colum] = df[colum].str.replace('（有）', '有限会社')\n",
    "    #英字を大文字にする\n",
    "    df[colum] = df[colum].str.upper()\n",
    "    #かっこ\n",
    "    df[colum] = df[colum].str.replace('（', '')\n",
    "    df[colum] = df[colum].str.replace('）', '')\n",
    "    df[colum] = df[colum].str.replace('［', '')\n",
    "    df[colum] = df[colum].str.replace('］', '')\n",
    "    #セミコロン\n",
    "    df[colum] = df[colum].str.replace('：', '')\n",
    "    #空白削除\n",
    "    df[colum] = df[colum].replace('\\s', '', regex=True)\n",
    "    \n",
    "    #先頭についている場合はその文字のみ消す\n",
    "    df[colum] = df[colum].replace('^注', '', regex=True)\n",
    "    df[colum] = df[colum].replace('^※', '', regex=True)\n",
    "    df[colum] = df[colum].replace('^＊', '', regex=True)\n",
    "    df[colum] = df[colum].replace('^旧', '', regex=True)\n",
    "    #後ろの場合は全部消す\n",
    "    df[colum] = df[colum].replace('注.*', '', regex=True)\n",
    "    df[colum] = df[colum].replace('※.*', '', regex=True)\n",
    "    df[colum] = df[colum].replace('＊.*', '', regex=True)\n",
    "    df[colum] = df[colum].replace('旧.*', '', regex=True)\n",
    "    #文字を消す\n",
    "    df[colum] = df[colum].str.replace('●', '')\n",
    "    df[colum] = df[colum].str.replace('・', '')\n",
    "    df[colum] = df[colum].str.replace('／', '')\n",
    "    df[colum] = df[colum].str.replace('．', '')\n",
    "    df[colum] = df[colum].str.replace('，', '')\n",
    "    df[colum] = df[colum].str.replace('、', '')\n",
    "    df[colum] = df[colum].str.replace('–', '－')\n",
    "    df[colum] = df[colum].str.replace('-', '－')\n",
    "    df[colum] = df[colum].str.replace('ー', '－')\n",
    "    df[colum] = df[colum].str.replace('―', '－')\n",
    "    df[colum] = df[colum].str.replace('‐', '－')\n",
    "    return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 54,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "b'\\\\u2013-\\\\u30fc\\\\u2015\\\\u2010\\\\u30fc'"
      ]
     },
     "execution_count": 54,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "'–-ー―‐ー'.encode('unicode-escape')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 55,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "b'\\\\u2013\\\\uff0d\\\\u30fc\\\\u2015\\\\u2010\\\\uff0d'"
      ]
     },
     "execution_count": 55,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "mojimoji.han_to_zen('–-ー―‐-').encode('unicode-escape')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 60,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>period</th>\n",
       "      <th>fdate</th>\n",
       "      <th>code</th>\n",
       "      <th>name</th>\n",
       "      <th>flg</th>\n",
       "      <th>renban</th>\n",
       "      <th>HolderName</th>\n",
       "      <th>SubHolderName</th>\n",
       "      <th>shares</th>\n",
       "      <th>p1shares</th>\n",
       "      <th>HolderName_NAYOSE</th>\n",
       "      <th>HolderName_Nayose</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>日本マスタートラスト信託銀行株式会社（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>12954000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>日本マスタ－トラスト信託銀行信託口</td>\n",
       "      <td>日本マスタ－トラスト信託銀行信託口</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>株式会社日本カストディ銀行（信託口）</td>\n",
       "      <td>NaN</td>\n",
       "      <td>6609000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>日本カストディ銀行信託口</td>\n",
       "      <td>日本カストディ銀行信託口</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>2</td>\n",
       "      <td>SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>5235000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部</td>\n",
       "      <td>ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>3</td>\n",
       "      <td>オーエスジーエージェント会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>3504000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>オ－エスジ－エ－ジェント会</td>\n",
       "      <td>オ－エスジ－エ－ジェント会</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>202311</td>\n",
       "      <td>20240216</td>\n",
       "      <td>61360</td>\n",
       "      <td>オーエスジー株式会社</td>\n",
       "      <td>1</td>\n",
       "      <td>4</td>\n",
       "      <td>オーエスジー持株会</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2621000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>オ－エスジ－持株会</td>\n",
       "      <td>オ－エスジ－持株会</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1410</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>2</td>\n",
       "      <td>藤井誠二</td>\n",
       "      <td>NaN</td>\n",
       "      <td>100000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>藤井誠二</td>\n",
       "      <td>藤井誠二</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1411</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>3</td>\n",
       "      <td>末廣紀彦</td>\n",
       "      <td>NaN</td>\n",
       "      <td>184000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>末廣紀彦</td>\n",
       "      <td>末廣紀彦</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1412</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>4</td>\n",
       "      <td>榎正規</td>\n",
       "      <td>NaN</td>\n",
       "      <td>63000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>榎正規</td>\n",
       "      <td>榎正規</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1413</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>5</td>\n",
       "      <td>寺田三男</td>\n",
       "      <td>NaN</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>寺田三男</td>\n",
       "      <td>寺田三男</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1414</th>\n",
       "      <td>202310</td>\n",
       "      <td>20240131</td>\n",
       "      <td>92790</td>\n",
       "      <td>株式会社ギフトホールディングス</td>\n",
       "      <td>3</td>\n",
       "      <td>6</td>\n",
       "      <td>原俊之</td>\n",
       "      <td>NaN</td>\n",
       "      <td>80000.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>原俊之</td>\n",
       "      <td>原俊之</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1415 rows × 12 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      period     fdate   code             name  flg  renban  \\\n",
       "0     202311  20240216  61360       オーエスジー株式会社    1       0   \n",
       "1     202311  20240216  61360       オーエスジー株式会社    1       1   \n",
       "2     202311  20240216  61360       オーエスジー株式会社    1       2   \n",
       "3     202311  20240216  61360       オーエスジー株式会社    1       3   \n",
       "4     202311  20240216  61360       オーエスジー株式会社    1       4   \n",
       "...      ...       ...    ...              ...  ...     ...   \n",
       "1410  202310  20240131  92790  株式会社ギフトホールディングス    3       2   \n",
       "1411  202310  20240131  92790  株式会社ギフトホールディングス    3       3   \n",
       "1412  202310  20240131  92790  株式会社ギフトホールディングス    3       4   \n",
       "1413  202310  20240131  92790  株式会社ギフトホールディングス    3       5   \n",
       "1414  202310  20240131  92790  株式会社ギフトホールディングス    3       6   \n",
       "\n",
       "                                             HolderName SubHolderName  \\\n",
       "0                               日本マスタートラスト信託銀行株式会社（信託口）           NaN   \n",
       "1                                    株式会社日本カストディ銀行（信託口）           NaN   \n",
       "2     SSBTCCLIENTOMNIBUSACCOUNT（常任代理人香港上海銀行東京支店カストディ...           NaN   \n",
       "3                                         オーエスジーエージェント会           NaN   \n",
       "4                                             オーエスジー持株会           NaN   \n",
       "...                                                 ...           ...   \n",
       "1410                                               藤井誠二           NaN   \n",
       "1411                                               末廣紀彦           NaN   \n",
       "1412                                                榎正規           NaN   \n",
       "1413                                               寺田三男           NaN   \n",
       "1414                                                原俊之           NaN   \n",
       "\n",
       "          shares  p1shares                                 HolderName_NAYOSE  \\\n",
       "0     12954000.0       NaN                                 日本マスタ－トラスト信託銀行信託口   \n",
       "1      6609000.0       NaN                                      日本カストディ銀行信託口   \n",
       "2      5235000.0       NaN  ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部   \n",
       "3      3504000.0       NaN                                     オ－エスジ－エ－ジェント会   \n",
       "4      2621000.0       NaN                                         オ－エスジ－持株会   \n",
       "...          ...       ...                                               ...   \n",
       "1410    100000.0       NaN                                              藤井誠二   \n",
       "1411    184000.0       NaN                                              末廣紀彦   \n",
       "1412     63000.0       NaN                                               榎正規   \n",
       "1413      4000.0       NaN                                              寺田三男   \n",
       "1414     80000.0       NaN                                               原俊之   \n",
       "\n",
       "                                     HolderName_Nayose  \n",
       "0                                    日本マスタ－トラスト信託銀行信託口  \n",
       "1                                         日本カストディ銀行信託口  \n",
       "2     ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部  \n",
       "3                                        オ－エスジ－エ－ジェント会  \n",
       "4                                            オ－エスジ－持株会  \n",
       "...                                                ...  \n",
       "1410                                              藤井誠二  \n",
       "1411                                              末廣紀彦  \n",
       "1412                                               榎正規  \n",
       "1413                                              寺田三男  \n",
       "1414                                               原俊之  \n",
       "\n",
       "[1415 rows x 12 columns]"
      ]
     },
     "execution_count": 60,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_input_nayose = func_nayose(df_input1, 'HolderName')\n",
    "df_input_nayose"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# DATA_KBNごとのフラグを立てたいので分ける"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 62,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_ookabunusi = df_input_nayose[df_input_nayose['flg']==1].drop_duplicates(subset=['HolderName_Nayose'])[['HolderName_Nayose']]\n",
    "df_ookabunusi['okabunushi_flg'] = 1\n",
    "df_jikokabu = df_input_nayose[df_input_nayose['flg']==2].drop_duplicates(subset=['HolderName_Nayose'])[['HolderName_Nayose']]\n",
    "df_jikokabu['jikokabu_flg'] = 1\n",
    "df_yakuin = df_input_nayose[df_input_nayose['flg']==3].drop_duplicates(subset=['HolderName_Nayose'])[['HolderName_Nayose']]\n",
    "df_yakuin['yakuin_flg'] = 1\n",
    "df_seisaku = df_input_nayose[df_input_nayose['flg']==4].drop_duplicates(subset=['HolderName_Nayose'])[['HolderName_Nayose']]\n",
    "df_seisaku['seisaku_flg'] = 1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 64,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>HolderName_Nayose</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>日本マスタ－トラスト信託銀行信託口</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>日本カストディ銀行信託口</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>オ－エスジ－エ－ジェント会</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>オ－エスジ－持株会</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1407</th>\n",
       "      <td>ギフトホ－ルディングス</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1410</th>\n",
       "      <td>藤井誠二</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1412</th>\n",
       "      <td>榎正規</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1413</th>\n",
       "      <td>寺田三男</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1414</th>\n",
       "      <td>原俊之</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1049 rows × 1 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                                     HolderName_Nayose\n",
       "0                                    日本マスタ－トラスト信託銀行信託口\n",
       "1                                         日本カストディ銀行信託口\n",
       "2     ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部\n",
       "3                                        オ－エスジ－エ－ジェント会\n",
       "4                                            オ－エスジ－持株会\n",
       "...                                                ...\n",
       "1407                                       ギフトホ－ルディングス\n",
       "1410                                              藤井誠二\n",
       "1412                                               榎正規\n",
       "1413                                              寺田三男\n",
       "1414                                               原俊之\n",
       "\n",
       "[1049 rows x 1 columns]"
      ]
     },
     "execution_count": 64,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_input_nayose_unique = df_input_nayose[['HolderName_Nayose']].drop_duplicates(subset=['HolderName_Nayose'])\n",
    "df_input_nayose_unique"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 65,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_input_nayose_unique1 = pd.merge(df_input_nayose_unique, df_ookabunusi, on='HolderName_Nayose', how='left')\n",
    "df_input_nayose_unique2 = pd.merge(df_input_nayose_unique1, df_jikokabu, on='HolderName_Nayose', how='left')\n",
    "df_input_nayose_unique3 = pd.merge(df_input_nayose_unique2, df_yakuin, on='HolderName_Nayose', how='left')\n",
    "df_input_nayose_unique4 = pd.merge(df_input_nayose_unique3, df_seisaku, on='HolderName_Nayose', how='left')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 87,
   "metadata": {},
   "outputs": [],
   "source": [
    "#df_input_nayose.to_excel(r\"S:\\B910\\執行業務課\\マクロ倶楽部\\王\\戦略\\TOPIXリバランス\\有価証券報告書データ\\temp_moto.xlsx\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 67,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>HolderName_Nayose</th>\n",
       "      <th>okabunushi_flg</th>\n",
       "      <th>jikokabu_flg</th>\n",
       "      <th>yakuin_flg</th>\n",
       "      <th>seisaku_flg</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>日本マスタ－トラスト信託銀行信託口</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>日本カストディ銀行信託口</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>オ－エスジ－エ－ジェント会</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>オ－エスジ－持株会</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1044</th>\n",
       "      <td>ギフトホ－ルディングス</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1045</th>\n",
       "      <td>藤井誠二</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1046</th>\n",
       "      <td>榎正規</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1047</th>\n",
       "      <td>寺田三男</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1048</th>\n",
       "      <td>原俊之</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1049 rows × 5 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                                     HolderName_Nayose  okabunushi_flg  \\\n",
       "0                                    日本マスタ－トラスト信託銀行信託口             1.0   \n",
       "1                                         日本カストディ銀行信託口             1.0   \n",
       "2     ＳＳＢＴＣＣＬＩＥＮＴＯＭＮＩＢＵＳＡＣＣＯＵＮＴ常任代理人香港上海銀行東京支店カストディ業務部             1.0   \n",
       "3                                        オ－エスジ－エ－ジェント会             1.0   \n",
       "4                                            オ－エスジ－持株会             1.0   \n",
       "...                                                ...             ...   \n",
       "1044                                       ギフトホ－ルディングス             0.0   \n",
       "1045                                              藤井誠二             0.0   \n",
       "1046                                               榎正規             0.0   \n",
       "1047                                              寺田三男             0.0   \n",
       "1048                                               原俊之             0.0   \n",
       "\n",
       "      jikokabu_flg  yakuin_flg  seisaku_flg  \n",
       "0              0.0         0.0          0.0  \n",
       "1              0.0         0.0          0.0  \n",
       "2              0.0         0.0          0.0  \n",
       "3              0.0         0.0          0.0  \n",
       "4              0.0         0.0          0.0  \n",
       "...            ...         ...          ...  \n",
       "1044           1.0         0.0          0.0  \n",
       "1045           0.0         1.0          0.0  \n",
       "1046           0.0         1.0          0.0  \n",
       "1047           0.0         1.0          0.0  \n",
       "1048           0.0         1.0          0.0  \n",
       "\n",
       "[1049 rows x 5 columns]"
      ]
     },
     "execution_count": 67,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_input_nayose_unique4[['okabunushi_flg', 'jikokabu_flg', 'yakuin_flg', 'seisaku_flg']] = df_input_nayose_unique4[['okabunushi_flg', 'jikokabu_flg', 'yakuin_flg', 'seisaku_flg']].fillna(0)\n",
    "df_input_nayose_unique4"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 名寄せマスターのパス"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 89,
   "metadata": {},
   "outputs": [],
   "source": [
    "path_master_old = glob.glob(r\"S:\\B910\\商品一課\\TOPIXFFW予想\\マスター\\topix_ffw_master*.xlsx\")[0]\n",
    "path_master_new = r\"S:\\B910\\商品一課\\TOPIXFFW予想\\マスター\\topix_ffw_master{}.xlsx\".format(today)\n",
    "path_master_backup = path_master_old.replace(r\"S:\\B910\\商品一課\\TOPIXFFW予想\\マスター\", r\"S:\\B910\\商品一課\\TOPIXFFW予想\\マスター\\old\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 90,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_master_old = pd.read_excel(path_master_old)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 91,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_master_old['IS_MASTER'] = 1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 92,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_nayose_master = pd.merge(df_input_nayose_unique4, df_master_old[['MASTER_NAME', 'IS_MASTER']], left_on='HOLDER_NAME_NAYOSE', right_on='MASTER_NAME', how='left')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 93,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_nayose_master_nan = df_nayose_master[df_nayose_master['IS_MASTER'].isna()]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 94,
   "metadata": {},
   "outputs": [],
   "source": [
    "#名前をキーにして銘柄コードを取得する"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 95,
   "metadata": {},
   "outputs": [],
   "source": [
    "#1年前の銘柄名も欲しい"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 69,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\2141298\\AppData\\Local\\Temp\\ipykernel_18732\\3657014005.py:10: UserWarning: pandas only supports SQLAlchemy connectable (engine/connection) or database string URI or sqlite3 DBAPI2 connection. Other DBAPI2 objects are not tested. Please consider using SQLAlchemy.\n",
      "  return pd.read_sql(query, cnxn)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>HOLDER_CODE_DB</th>\n",
       "      <th>HOLDER_NAME_DB</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>13060</td>\n",
       "      <td>NEXT FUNDS TOPIX連動型上場投信                       ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>13190</td>\n",
       "      <td>NEXT FUNDS 日経300株価指数連動型上場投信</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>13210</td>\n",
       "      <td>NEXT FUNDS 日経225連動型上場投信                       ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>13240</td>\n",
       "      <td>N F ロシア株式指数連動型上場投信                            ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>13680</td>\n",
       "      <td>IFREEETF TOPIXﾀﾞﾌﾞﾙｲﾝﾊﾞｰｽ(-2倍)指数              ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9809</th>\n",
       "      <td>98520</td>\n",
       "      <td>CBｸﾞﾙｰﾌﾟﾏﾈｼﾞﾒﾝﾄ</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9810</th>\n",
       "      <td>98670</td>\n",
       "      <td>ソレキア</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9811</th>\n",
       "      <td>98950</td>\n",
       "      <td>コンセック</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9812</th>\n",
       "      <td>99340</td>\n",
       "      <td>因幡電機産業</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9813</th>\n",
       "      <td>99760</td>\n",
       "      <td>セキチュー</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>9814 rows × 2 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     HOLDER_CODE_DB                                     HOLDER_NAME_DB\n",
       "0             13060  NEXT FUNDS TOPIX連動型上場投信                       ...\n",
       "1             13190  NEXT FUNDS 日経300株価指数連動型上場投信                      \n",
       "2             13210  NEXT FUNDS 日経225連動型上場投信                       ...\n",
       "3             13240  N F ロシア株式指数連動型上場投信                            ...\n",
       "4             13680  IFREEETF TOPIXﾀﾞﾌﾞﾙｲﾝﾊﾞｰｽ(-2倍)指数              ...\n",
       "...             ...                                                ...\n",
       "9809          98520                         CBｸﾞﾙｰﾌﾟﾏﾈｼﾞﾒﾝﾄ           \n",
       "9810          98670                               ソレキア                \n",
       "9811          98950                                コンセック              \n",
       "9812          99340                                 因幡電機産業            \n",
       "9813          99760                                セキチュー              \n",
       "\n",
       "[9814 rows x 2 columns]"
      ]
     },
     "execution_count": 69,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "def sql_name_db():\n",
    "    query = f'''\n",
    "    select\n",
    "        unique CODE as HOLDER_CODE_DB,\n",
    "        NAME as HOLDER_NAME_DB\n",
    "    from(\n",
    "            select\n",
    "                code,\n",
    "                NAME_MAIN as NAME\n",
    "            from\n",
    "                pt2.V_MT_EQ\n",
    "            where\n",
    "                SHU_SHIJO <> '0' \n",
    "           UNION ALL select\n",
    "                code,\n",
    "                NAME \n",
    "            from\n",
    "                pt2.V_MT_EQ\n",
    "            where\n",
    "                SHU_SHIJO <> '0' \n",
    "\n",
    "            UNION\n",
    "                ALL\n",
    "                select\n",
    "                    code,\n",
    "                    NAME_MAIN as NAME\n",
    "                from\n",
    "                    pt2.V_MT_EQ_S\n",
    "                where\n",
    "                    SHU_SHIJO <> '0' and\n",
    "                    D_DATE = '{today}' \n",
    "            UNION ALL select\n",
    "                code,\n",
    "                NAME \n",
    "            from\n",
    "                pt2.V_MT_EQ_S\n",
    "            where\n",
    "                SHU_SHIJO <> '0' and\n",
    "                D_DATE = '{today}'\n",
    "          )\n",
    "    '''\n",
    "    return sql(query)\n",
    "df_name_db = sql_name_db()\n",
    "df_name_db"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 97,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_name_db = func_nayose(df_name_db, 'HOLDER_NAME_DB').drop_duplicates(['HOLDER_CODE_DB', 'HOLDER_NAME_DB_NAYOSE']).copy()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 98,
   "metadata": {},
   "outputs": [],
   "source": [
    "#(4760, 3434) (7111, 3390)が同じ名前で存在しているので消す\n",
    "df_name_db = df_name_db[~df_name_db['HOLDER_CODE_DB'].isin(['34340', '33900'])]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 99,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>HOLDER_CODE_DB</th>\n",
       "      <th>HOLDER_NAME_DB</th>\n",
       "      <th>HOLDER_NAME_DB_NAYOSE</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [HOLDER_CODE_DB, HOLDER_NAME_DB, HOLDER_NAME_DB_NAYOSE]\n",
       "Index: []"
      ]
     },
     "execution_count": 99,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_name_db[(df_name_db.duplicated('HOLDER_NAME_DB_NAYOSE', keep=False))].sort_values('HOLDER_NAME_DB_NAYOSE')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 100,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_nayose_master_nan1 = pd.merge(df_nayose_master_nan, df_name_db, left_on='HOLDER_NAME_NAYOSE', right_on='HOLDER_NAME_DB_NAYOSE', how='left')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 101,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>RENBAN</th>\n",
       "      <th>PERIOD</th>\n",
       "      <th>F_DATE</th>\n",
       "      <th>CODE</th>\n",
       "      <th>NAME</th>\n",
       "      <th>DATA_KBN</th>\n",
       "      <th>HOLDER_NAME</th>\n",
       "      <th>SUB_HOLDER_NAME</th>\n",
       "      <th>SHARES</th>\n",
       "      <th>SHARES_PRIOR1YEAR</th>\n",
       "      <th>HOLDER_NAME_NAYOSE</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [RENBAN, PERIOD, F_DATE, CODE, NAME, DATA_KBN, HOLDER_NAME, SUB_HOLDER_NAME, SHARES, SHARES_PRIOR1YEAR, HOLDER_NAME_NAYOSE]\n",
       "Index: []"
      ]
     },
     "execution_count": 101,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#名寄せした後のHOLDER_NAMENAYOが空になっているか確認\n",
    "df_input_nayose[df_input_nayose['HOLDER_NAME_NAYOSE']==\"\"]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 102,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_nayose_master_nan1['FFW_FLG'] = None\n",
    "df_nayose_master_nan1['GROUP'] = None\n",
    "df_nayose_master_nan1['MEMO'] = None"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 103,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_nayose_master_nan2 = df_nayose_master_nan1[['HOLDER_NAME_NAYOSE', 'OOKABUNUSI_FLG', 'JIKOKABU_FLG', 'YAKUIN_FLG', 'SEISAKU_FLG', 'HOLDER_CODE_DB', 'FFW_FLG', 'GROUP', 'MEMO']].copy()#.to_excel(r\"S:\\B910\\商品一課\\TOPIXFFW予想\\マスター\\マスター追加\\topix_ffw_master追加{}.xlsx\".format(today))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 104,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>HOLDER_NAME_NAYOSE</th>\n",
       "      <th>OOKABUNUSI_FLG</th>\n",
       "      <th>JIKOKABU_FLG</th>\n",
       "      <th>YAKUIN_FLG</th>\n",
       "      <th>SEISAKU_FLG</th>\n",
       "      <th>HOLDER_CODE_DB</th>\n",
       "      <th>FFW_FLG</th>\n",
       "      <th>GROUP</th>\n",
       "      <th>MEMO</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [HOLDER_NAME_NAYOSE, OOKABUNUSI_FLG, JIKOKABU_FLG, YAKUIN_FLG, SEISAKU_FLG, HOLDER_CODE_DB, FFW_FLG, GROUP, MEMO]\n",
       "Index: []"
      ]
     },
     "execution_count": 104,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_nayose_master_nan2"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 105,
   "metadata": {},
   "outputs": [],
   "source": [
    "#大株主のみが１のものは固定か浮動か判定する必要があるが他は必ず固定株。\n",
    "#固定株0，浮動株２\n",
    "df_nayose_master_nan2.loc[((df_nayose_master_nan2['JIKOKABU_FLG']==1)|(df_nayose_master_nan2['YAKUIN_FLG']==1)|(df_nayose_master_nan2['SEISAKU_FLG']==1)), 'FFW_FLG'] = 0"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 106,
   "metadata": {},
   "outputs": [],
   "source": [
    "#手で記入する必要のある大株主のデータ＝FFW_FLGが未入力のデータと製作保有株の\n",
    "df_nayose_master_nan3 = df_nayose_master_nan2.sort_values(['FFW_FLG', 'SEISAKU_FLG'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 107,
   "metadata": {},
   "outputs": [],
   "source": [
    "#古いマスターに新しく存在しないものを加えて新規に保存する\n",
    "df_nayose_master_nan4 = df_nayose_master_nan3.rename({'HOLDER_CODE_DB':'MASTER_CODE', 'HOLDER_NAME_NAYOSE':'MASTER_NAME'},axis=1)\n",
    "df_nayose_master_nan4['D_DATE'] = today"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 108,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>MASTER_NAME</th>\n",
       "      <th>OOKABUNUSI_FLG</th>\n",
       "      <th>JIKOKABU_FLG</th>\n",
       "      <th>YAKUIN_FLG</th>\n",
       "      <th>SEISAKU_FLG</th>\n",
       "      <th>MASTER_CODE</th>\n",
       "      <th>FFW_FLG</th>\n",
       "      <th>GROUP</th>\n",
       "      <th>MEMO</th>\n",
       "      <th>D_DATE</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [MASTER_NAME, OOKABUNUSI_FLG, JIKOKABU_FLG, YAKUIN_FLG, SEISAKU_FLG, MASTER_CODE, FFW_FLG, GROUP, MEMO, D_DATE]\n",
       "Index: []"
      ]
     },
     "execution_count": 108,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_nayose_master_nan4.loc[(df_nayose_master_nan4['MASTER_CODE'])]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 109,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_master_old = df_master_old.drop(['IS_MASTER'],axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 110,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_master_new = pd.concat([df_master_old, df_nayose_master_nan4])"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# 古いマスターを別の場所に移動して新しいマスターを保存する"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 111,
   "metadata": {},
   "outputs": [],
   "source": [
    "import shutil\n",
    "if len(df_nayose_master_nan2):\n",
    "    shutil.move(path_master_old, path_master_backup)\n",
    "    df_master_new.to_excel(path_master_new, index=None)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.11"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
